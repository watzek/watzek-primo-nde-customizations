import { selectFullDisplayRecord } from '../utils/fullDisplayRecordSelector';
import {selectDeliveryEntities} from '../utils/DeliveryRecordSelector';
import { Component, Input, OnInit, ElementRef, InjectionToken, Inject } from '@angular/core';
import { Store } from '@ngrx/store';
import { map, filter, switchMap } from 'rxjs/operators';
import {NosOptions, NOS_OPTIONS} from './nos-options.config';
import { HttpClient, HttpClientModule } from '@angular/common/http';

export const NOS_OPTIONS_TOKEN =
  new InjectionToken<NosOptions>('NOS_OPTIONS');

@Component({
  selector: 'custom-not-on-shelf',
  standalone: true,
  imports: [],
  templateUrl: './not-on-shelf.component.html',
  styleUrl: './not-on-shelf.component.scss',
  providers: [
    { provide: NOS_OPTIONS_TOKEN, useValue: NOS_OPTIONS }
  ]
})


export class NotOnShelfComponent {
  docid: string | undefined;
  deliv: any | undefined;
  title: any | undefined;
  author: string | undefined;
  callNumber: string | any;
  mainLocation: any | undefined;
  subLocation: any | undefined;
  location: any | undefined;
  url: string | undefined;
  record: any | undefined;
  mapping: any | undefined;
  instCode = '01ALLIANCE_LCC';
  mmsid: any | undefined;
  
  nosShow= false;


   constructor(
    private store: Store, 
    private el: ElementRef,
    private http: HttpClient,
    @Inject(NOS_OPTIONS_TOKEN) private nosOptions: NosOptions 
    //makes this.nosOptions available to class
    ) { }


    ngOnInit() {
      const isFullDisplay =
        window.location.pathname.includes('fulldisplay') ||
        new URLSearchParams(window.location.search).has('docid');

      if (!isFullDisplay) {
        this.el.nativeElement.style.display = 'none';
      }

     this.store
  .select(selectFullDisplayRecord)
  .pipe(
    filter(record => !!record),

    map(record => ({
      record,
      docid: record?.pnx?.control?.recordid?.[0],
      callNumber: record?.enrichment?.virtualBrowseObject?.callNumber, //this comes in late
    })),

    filter(({ docid }) => !!docid),
    filter(({ callNumber }) => !!callNumber),

    switchMap(({ record, docid, callNumber }) =>
      this.store.select(selectDeliveryEntities).pipe(
        map(delivRecord => {
          const recordDelivery = delivRecord?.[docid];

          return {
            record,
            docid,
            delivery: recordDelivery,
            mainLocation:
              recordDelivery?.delivery?.bestlocation?.mainLocation,
            callNumber
          };
        })
      )
    ),

    // â­ THIS IS THE MISSING PIECE
    filter(({ mainLocation }) => !!mainLocation),
    filter(({ mainLocation }) => !!this.nosOptions[mainLocation])
  )
  .subscribe(result => {
    this.record = result.record;
    this.docid = result.docid;
    this.deliv = result.delivery;
    this.mainLocation = result.mainLocation;
   // this.callNumber = result.callNumber;

    const qm = this.nosOptions[this.mainLocation][0].query_mappings[0];
    console.log(this.record);

    this.title = this.record?.pnx?.display?.title?.[0];
    this.author = this.record?.pnx?.addata?.au?.[0];
    this.subLocation = this.deliv?.delivery?.bestlocation?.subLocation;
    //this.mmsid - this.record?.pnx?.control?.sourcerecordid?.[0];
    const mmsid = this.record?.pnx?.control?.sourcerecordid[0];
    console.log(mmsid);

    const callNumber=this.sruCall(mmsid);



    this.location = `${this.mainLocation} ${this.subLocation}`;

    const urlBase = this.nosOptions[this.mainLocation][0].urlBase;

    const params = {
      [qm.title]: this.title,
      [qm.author]: this.author,
      [qm.callnumber]: this.callNumber,
      [qm.location]: this.location
    };

    this.url = this.buildUrl(urlBase, params);
    this.nosShow = true;
  });



    }


buildUrl(url: string, params: Record<string, string | undefined>): string {
  const searchParams = new URLSearchParams();

  Object.entries(params).forEach(([key, value]) => {
    if (value != null) {
      searchParams.set(key, value);
    }
  });

  const queryString = searchParams.toString();

  return queryString
    ? `${url}${url.includes('?') ? '&' : '?'}${queryString}`
    : url;
}


private sruCall(mmsid: string): void {
        const url = `https://na01.alma.exlibrisgroup.com/view/sru/${this.instCode}?version=1.2&operation=searchRetrieve&query=alma.mms_id=${mmsid}`;
        console.log('SRU URL:', url);
        this.http.get(url, { responseType: 'text' }).subscribe(response => {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(response, 'text/xml');
            const fields = xmlDoc.getElementsByTagName('datafield');

            let found = false;
            for (let i = 0; i < fields.length; i++) {
                const field = fields[i];
                if (field.getAttribute('tag') === 'AVA') {
                  this.callNumber = field.getElementsByTagName('subfield')[5]?.textContent;
                  //this.callNumber=callNumber;
                  found=true;
                  //return callNumber;

                }
            }
            if (!found) {
                this.nosShow = false;
            }
        });
    }



}
